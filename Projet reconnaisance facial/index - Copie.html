<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Reconnaissance faciale - Correspondance</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    body { margin: 0; }
    canvas, video { position: absolute; top: 0; left: 0; }
  </style>
</head>
<body>
  <video id="video" autoplay muted></video>

  <script>
    const video = document.getElementById('video');

    const knownFaces = [
      { name: 'Moi', file: '/known_faces/moi.jpg' }
    ];

    async function loadLabeledImages() {
  const labels = ['Moi', 'Papa', 'Maman']; // mets ici les noms des visages attendus

  return Promise.all(
    labels.map(async (label) => {
      const descriptions = [];

      try {
        const imgUrl = `/known_faces/${label}.jpg`;
        const img = await faceapi.fetchImage(imgUrl);
        const detection = await faceapi
          .detectSingleFace(img)
          .withFaceLandmarks()
          .withFaceDescriptor();

        if (!detection) {
          throw new Error(`Aucun visage détecté pour ${label}`);
        }

        descriptions.push(detection.descriptor);
        return new faceapi.LabeledFaceDescriptors(label, descriptions);
      } catch (err) {
        console.warn(`❌ ${label} ignoré : ${err.message}`);
        return null;
      }
    })
  ).then(results => results.filter(Boolean)); // enlève les null
}

    window.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('/models'),
        faceapi.nets.ssdMobilenetv1.loadFromUri('/models')
      ]);

      const labeledDescriptors = await loadLabeledImages();
      const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);

      navigator.mediaDevices.getUserMedia({ video: {} })
        .then(stream => {
          video.srcObject = stream;
        })
        .catch(console.error);

      video.addEventListener('play', () => {
        const canvas = faceapi.createCanvasFromMedia(video);
        document.body.append(canvas);

        const displaySize = { width: video.videoWidth, height: video.videoHeight };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
          const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptors();

          const resized = faceapi.resizeResults(detections, displaySize);

          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          resized.forEach(detection => {
            const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
            const box = detection.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { label: bestMatch.toString() });
            drawBox.draw(canvas);
          });
        }, 500);
      });
    });
  </script>
</body>
</html>
